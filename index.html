<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRACA — Wallet Verification</title>
  <style>
    :root {
      --bg: #fafaf9;
      --fg: #1c1917;
      --muted: #78716c;
      --border: #e7e5e4;
      --green: #15803d;
      --font-display: "Times New Roman", Georgia, serif;
      --font-mono: "SF Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
      --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0c0a09;
        --fg: #fafaf9;
        --muted: #a8a29e;
        --border: #292524;
        --green: #22c55e;
      }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .container {
      width: 100%;
      max-width: 420px;
    }

    .separator {
      height: 1px;
      background: var(--border);
      margin: 32px 0;
    }

    .separator-sm {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    /* Branding */
    .brand { text-align: center; }
    .brand h1 {
      font-family: var(--font-display);
      font-size: 30px;
      font-weight: 400;
      letter-spacing: 0.08em;
    }
    .brand p {
      margin-top: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--muted);
    }

    /* Balance */
    .balance { text-align: center; }
    .balance .label {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--muted);
    }
    .balance .amount {
      margin-top: 12px;
      font-family: var(--font-display);
      font-size: 48px;
      font-weight: 400;
    }
    .balance .unit {
      margin-top: 8px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    /* Holdings list */
    .holdings-list {
      border: 1px solid var(--border);
    }
    .holding-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
    }
    .holding-row + .holding-row {
      border-top: 1px solid var(--border);
    }
    .holding-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .holding-token {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .holding-network {
      font-size: 10px;
      color: var(--muted);
    }
    .holding-right {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .holding-amount {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 400;
    }
    .holding-value {
      font-size: 10px;
      color: var(--muted);
    }

    /* Address */
    .address-section .addr-label {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--muted);
    }
    .address-box {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .address-box .addr-text {
      flex: 1;
      word-break: break-all;
      border: 1px solid var(--border);
      padding: 12px;
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .copy-btn, .action-btn {
      flex-shrink: 0;
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .copy-btn {
      padding: 8px;
      border: none;
    }
    .copy-btn:hover, .action-btn:hover {
      background: var(--fg);
      color: var(--bg);
    }

    /* Timestamp */
    .timestamp {
      margin-top: 16px;
      text-align: center;
      font-size: 10px;
      color: var(--muted);
    }

    /* Actions */
    .actions {
      margin-top: 32px;
      display: flex;
      gap: 12px;
    }
    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      text-decoration: none;
      color: var(--fg);
    }

    .explorer-links {
      margin-top: 12px;
      display: flex;
      gap: 12px;
    }
    .explorer-link {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      border: 1px solid var(--border);
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      text-decoration: none;
      color: var(--muted);
      transition: all 0.15s;
    }
    .explorer-link:hover {
      background: var(--fg);
      color: var(--bg);
    }

    .footer {
      margin-top: 40px;
      text-align: center;
      font-size: 10px;
      color: var(--muted);
    }

    /* Loading / error states */
    .state-msg {
      text-align: center;
      padding: 80px 0;
    }
    .state-msg p {
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--muted);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* Wallet name */
    .wallet-name {
      margin-top: 8px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }

    /* No address prompt */
    .prompt-section { text-align: center; }
    .prompt-section h2 {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 400;
    }
    .prompt-section p {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .prompt-section code {
      display: block;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Branding (always visible) -->
    <div class="brand">
      <h1>DRACA</h1>
      <p>Physical Crypto Verification</p>
    </div>

    <!-- Loading state -->
    <div id="loading" class="hidden">
      <div class="separator"></div>
      <div class="state-msg">
        <div class="spinner"></div>
        <p>Reading blockchain...</p>
      </div>
    </div>

    <!-- No address prompt -->
    <div id="no-address" class="hidden">
      <div class="separator"></div>
      <div class="prompt-section">
        <h2>Verify a Wallet</h2>
        <p>Add a wallet address to the URL to verify its balance:</p>
        <code>?address=0x1234...abcd</code>
      </div>
    </div>

    <!-- Error state -->
    <div id="error" class="hidden">
      <div class="separator"></div>
      <div class="state-msg">
        <p id="error-msg">Failed to read balances</p>
      </div>
    </div>

    <!-- Wallet content -->
    <div id="wallet-content" class="hidden">
      <div id="wallet-name-section" class="wallet-name hidden"></div>

      <div class="separator"></div>

      <!-- Total Balance -->
      <div class="balance">
        <p class="label">Total Verified Balance</p>
        <p class="amount" id="total-balance">$0.00</p>
      </div>

      <!-- Holdings (dynamically populated) -->
      <div id="holdings" class="hidden">
        <div class="separator-sm"></div>
        <div id="holdings-list" class="holdings-list"></div>
      </div>

      <div class="separator"></div>

      <!-- Address -->
      <div class="address-section">
        <p class="addr-label">Wallet Address</p>
        <div class="address-box">
          <p class="addr-text" id="wallet-address"></p>
          <button class="copy-btn" id="copy-btn" title="Copy address">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Timestamp -->
      <p class="timestamp" id="timestamp"></p>

      <!-- Actions -->
      <div class="actions">
        <button class="action-btn" id="refresh-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Refresh
        </button>
      </div>

      <!-- Explorer links -->
      <div class="explorer-links">
        <a id="link-polygon" class="explorer-link hidden" target="_blank" rel="noopener noreferrer">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
          Polygonscan
        </a>
        <a id="link-ethereum" class="explorer-link hidden" target="_blank" rel="noopener noreferrer">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
          Etherscan
        </a>
      </div>
    </div>

    <p class="footer">This is a public verification page. No login required.</p>
  </div>

  <!-- ethers.js v6 from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
  <script>
    // Contract addresses
    const USDC = {
      polygon: "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359",
      ethereum: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    };
    const USDT = {
      polygon: "0xc2132D05D31c914a87C6611C10748AEb04B58e8F",
      ethereum: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
    };
    const RPC = {
      polygon: "https://polygon-bor-rpc.publicnode.com",
      ethereum: "https://ethereum-rpc.publicnode.com",
    };
    const EXPLORER = {
      polygon: "https://polygonscan.com",
      ethereum: "https://etherscan.io",
    };
    const ERC20_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
    ];

    // Get address from URL
    const params = new URLSearchParams(window.location.search);
    const address = params.get("address");
    const walletName = params.get("name");

    // DOM elements
    const $loading = document.getElementById("loading");
    const $noAddress = document.getElementById("no-address");
    const $error = document.getElementById("error");
    const $errorMsg = document.getElementById("error-msg");
    const $content = document.getElementById("wallet-content");
    const $totalBalance = document.getElementById("total-balance");
    const $walletAddress = document.getElementById("wallet-address");
    const $timestamp = document.getElementById("timestamp");
    const $holdings = document.getElementById("holdings");
    const $holdingsList = document.getElementById("holdings-list");
    const $walletNameSection = document.getElementById("wallet-name-section");

    if (!address || !address.match(/^0x[a-fA-F0-9]{40}$/)) {
      $noAddress.classList.remove("hidden");
    } else {
      init();
    }

    async function init() {
      $loading.classList.remove("hidden");
      $walletAddress.textContent = address;

      if (walletName) {
        $walletNameSection.textContent = walletName;
        $walletNameSection.classList.remove("hidden");
      }

      // Set up explorer links
      document.getElementById("link-polygon").href = `${EXPLORER.polygon}/address/${address}`;
      document.getElementById("link-ethereum").href = `${EXPLORER.ethereum}/address/${address}`;

      try {
        await fetchBalances();
      } catch (err) {
        $loading.classList.add("hidden");
        $error.classList.remove("hidden");
        $errorMsg.textContent = "Failed to read balances: " + (err.message || err);
        console.error("Balance fetch error:", err);
      }
    }

    async function fetchPrices() {
      try {
        const res = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=pol-ex-matic,ethereum&vs_currencies=usd"
        );
        const data = await res.json();
        return {
          pol: data["pol-ex-matic"]?.usd || 0,
          eth: data["ethereum"]?.usd || 0,
        };
      } catch {
        return { pol: 0, eth: 0 };
      }
    }

    async function fetchBalances() {
      const polygonProvider = new ethers.JsonRpcProvider(RPC.polygon);
      const ethereumProvider = new ethers.JsonRpcProvider(RPC.ethereum);

      // Fetch balances and prices in parallel
      const [
        polUsdcRaw, polUsdtRaw, polNativeRaw, polUsdcDec, polUsdtDec,
        ethUsdcRaw, ethUsdtRaw, ethNativeRaw, ethUsdcDec, ethUsdtDec,
        prices,
      ] = await Promise.all([
        new ethers.Contract(USDC.polygon, ERC20_ABI, polygonProvider).balanceOf(address),
        new ethers.Contract(USDT.polygon, ERC20_ABI, polygonProvider).balanceOf(address),
        polygonProvider.getBalance(address),
        new ethers.Contract(USDC.polygon, ERC20_ABI, polygonProvider).decimals(),
        new ethers.Contract(USDT.polygon, ERC20_ABI, polygonProvider).decimals(),
        new ethers.Contract(USDC.ethereum, ERC20_ABI, ethereumProvider).balanceOf(address),
        new ethers.Contract(USDT.ethereum, ERC20_ABI, ethereumProvider).balanceOf(address),
        ethereumProvider.getBalance(address),
        new ethers.Contract(USDC.ethereum, ERC20_ABI, ethereumProvider).decimals(),
        new ethers.Contract(USDT.ethereum, ERC20_ABI, ethereumProvider).decimals(),
        fetchPrices(),
      ]);

      const polUsdc = parseFloat(ethers.formatUnits(polUsdcRaw, polUsdcDec));
      const polUsdt = parseFloat(ethers.formatUnits(polUsdtRaw, polUsdtDec));
      const polNative = parseFloat(ethers.formatEther(polNativeRaw));
      const ethUsdc = parseFloat(ethers.formatUnits(ethUsdcRaw, ethUsdcDec));
      const ethUsdt = parseFloat(ethers.formatUnits(ethUsdtRaw, ethUsdtDec));
      const ethNative = parseFloat(ethers.formatEther(ethNativeRaw));

      // Build holdings list — only tokens with a balance
      const holdings = [];
      if (polUsdc > 0.01) holdings.push({ token: "USDC", network: "Polygon", amount: polUsdc.toFixed(2), value: polUsdc, prefix: "$" });
      if (polUsdt > 0.01) holdings.push({ token: "USDT", network: "Polygon", amount: polUsdt.toFixed(2), value: polUsdt, prefix: "$" });
      if (ethUsdc > 0.01) holdings.push({ token: "USDC", network: "Ethereum", amount: ethUsdc.toFixed(2), value: ethUsdc, prefix: "$" });
      if (ethUsdt > 0.01) holdings.push({ token: "USDT", network: "Ethereum", amount: ethUsdt.toFixed(2), value: ethUsdt, prefix: "$" });
      if (polNative > 0.0001) holdings.push({ token: "POL", network: "Polygon", amount: polNative.toFixed(4), value: polNative * prices.pol, prefix: "" });
      if (ethNative > 0.0001) holdings.push({ token: "ETH", network: "Ethereum", amount: ethNative.toFixed(4), value: ethNative * prices.eth, prefix: "" });

      // Total value
      const grandTotal = holdings.reduce((sum, h) => sum + h.value, 0);
      $totalBalance.textContent = `$${grandTotal.toFixed(2)}`;

      // Render holdings
      $holdingsList.innerHTML = "";
      if (holdings.length > 0) {
        $holdings.classList.remove("hidden");
        for (const h of holdings) {
          const row = document.createElement("div");
          row.className = "holding-row";
          row.innerHTML = `
            <div class="holding-left">
              <span class="holding-token">${h.token}</span>
              <span class="holding-network">${h.network}</span>
            </div>
            <div class="holding-right">
              <span class="holding-amount">${h.prefix}${h.amount}</span>
              ${h.prefix !== "$" && h.value > 0 ? `<span class="holding-value">$${h.value.toFixed(2)}</span>` : ""}
            </div>
          `;
          $holdingsList.appendChild(row);
        }
      } else {
        $holdings.classList.add("hidden");
      }

      // Explorer links
      const hasPolygon = polUsdc > 0 || polUsdt > 0 || polNative > 0.0001;
      const hasEthereum = ethUsdc > 0 || ethUsdt > 0 || ethNative > 0.0001;
      document.getElementById("link-polygon").classList.toggle("hidden", !hasPolygon);
      document.getElementById("link-ethereum").classList.toggle("hidden", !hasEthereum);

      // Timestamp
      const now = new Date();
      $timestamp.textContent = `Last verified: ${now.toLocaleDateString("en-GB", {
        day: "numeric", month: "long", year: "numeric",
      })} ${now.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })}`;

      // Show content, hide loading
      $loading.classList.add("hidden");
      $content.classList.remove("hidden");
    }

    // Copy button
    document.getElementById("copy-btn").addEventListener("click", function () {
      navigator.clipboard.writeText(address).then(() => {
        this.title = "Copied!";
        setTimeout(() => { this.title = "Copy address"; }, 2000);
      });
    });

    // Refresh button
    document.getElementById("refresh-btn").addEventListener("click", async function () {
      this.disabled = true;
      this.querySelector("svg").style.animation = "spin 0.8s linear infinite";
      try {
        await fetchBalances();
      } catch {
        // Silent fail on refresh
      }
      this.disabled = false;
      this.querySelector("svg").style.animation = "";
    });
  </script>
</body>
</html>
